var PhyloCanvas=function(){function a(a){for(var b=0;null!=a;)b+=a.offsetTop,a=a.offsetParent;return b}function b(a){for(var b=0;null!=a;)b+=a.offsetLeft,a=a.offsetParent;return b}function c(a){return a.backingStorePixelRatio||a.webkitBackingStorePixelRatio||a.mozBackingStorePixelRatio||a.msBackingStorePixelRatio||a.oBackingStorePixelRatio||a.backingStorePixelRatio||1}function e(a,b){return"string"==typeof b?function(c){return a[b](c)}:function(){return b(a)}}var f={FORTYFIVE:Math.PI/4,QUARTER:Math.PI/2,HALF:Math.PI,FULL:2*Math.PI},g={x:"star",s:"square",o:"circle",t:"triangle"},h=function(){this.angle=0,this.branchLength=!1,this.canvas,this.centerx=0,this.centery=0,this.children=[],this.childNo=0,this.collapsed=!1,this.color="rgba(0,0,0,1)",this.data={},this.id="",this.interx=0,this.intery=0,this.label="",this.leaf=!0,this.maxChildAngle=0,this.minChildAngle=f.FULL,this.nodeShape="circle",this.onselected=null,this.parent=null,this.radius=1,this.selected=!1,this.startx=0,this.starty=0,this.totalBranchLength=0,this.tree={}},i=function(a){this.tree=a,this.div=document.createElement("div"),this.div.style.display="none",this.div.style.position="fixed",this.div.style.border="1px solid #CCCCCC",this.div.className="contextMenu",this.elements=[{text:"Redraw Subtree",handler:"redrawTreeFromBranch",internal:!0,leaf:!1},{text:"Show Labels",handler:"displayLabels",internal:!1,leaf:!1},{text:"Hide Labels",handler:"hideLabels",internal:!1,leaf:!1},{text:"Collapse/Expand branch",handler:"toggleCollapsed",internal:!0,leaf:!1}],this.tree.canvasEl.appendChild(this.div)},j=function(a){this.div=a,this.cl=document.createElement("canvas"),this.cl.id=a.id+"Loader",this.cl.style.position="absolute",this.cl.style.top=a.offsetHeight/4+"px",this.cl.style.left=a.offsetWidth/4+"px",this.cl.height=a.offsetHeight/2,this.cl.width=a.offsetWidth/2,this.cl.style.zIndex="1000",a.appendChild(this.cl),this.ctx=document.getElementById(a.id+"Loader").getContext("2d"),this.drawer=null,this.loader_radius,this.loader_step=2*Math.PI/360,this.message="Loading ..."},k=function(a){this.tree=a,this.cel=document.createElement("canvas"),this.cel.id=this.tree.canvasEl.id+"Navi",this.cel.style.zIndex="100",this.cel.style.backgroundColor="#FFFFFF",this.cel.width=this.tree.canvas.canvas.width/3,this.cel.height=this.tree.canvas.canvas.height/3,this.cel.style.position="absolute",this.cel.style.bottom="0px",this.cel.style.right="0px",this.cel.style.border="1px solid #CCCCCC",this.tree.canvasEl.appendChild(this.cel),this.ctx=this.cel.getContext("2d"),this.ctx.translate(this.cel.width/2,this.cel.height/2),this.ctx.save()},l=function(a){"string"==typeof a&&(a=document.getElementById(a)),this.branches={},this.leaves=[],this.loader=new j(a),this.root=!1,this.lastId=0,this.origBL={},this.origP={},this.canvasEl=a;var b=window.getComputedStyle(this.canvasEl);console.debug(b.position),"static"==b.position&&(this.canvasEl.style.position="relative");var d=document.createElement("canvas");d.id=a.id+"pCanvas",d.className="phylocanvas",d.style.position="relative",d.style.backgroundColor="#FFFFFF",d.height=a.clientHeight||400,d.width=a.clientWidth||400,d.style.zIndex="1",this.canvasEl.appendChild(d),this.contextMenu=new i(this),this.drawn=!1,this.selectedNodes=[],this.zoom=1,this.pickedup=!1,this.dragging=!1,this.startx,this.starty,this.pickedup=!1,this.baseNodeSize=1,this.curx,this.cury,this.origx,this.origy,this.loader.run(),this.canvas=d.getContext("2d"),this.canvas.canvas.onselectstart=function(){return!1},this.canvas.fillStyle="#000000",this.canvas.strokeStyle="#000000",this.canvas.save(),this.offsetx=this.canvas.canvas.width/2,this.offsety=this.canvas.canvas.height/2,this.selectedColor="rgba(49,151,245,1)",this.highlightColor="rgba(49,151,245,1)",this.highlightWidth=3,this.selectedNodeSizeIncrease=0,this.branchColor="rgba(0,0,0,1)",this.branchScalar=1,this.internalNodesSelectable=!0,this.showLabels=!0,this.showBootstraps=!1,this.treeType="radial",this.maxBranchLength=0,this.lineWidth=1,this.textSize=10,this.font="sans-serif",this.unselectOnClickAway=!0,this.rightClickZoom=!0,this.onselected=null,this.use_navigator&&(this.navigator=new k(this)),this.canvas.canvas.oncontextmenu=e(this,"clicked"),this.canvas.canvas.onclick=e(this,"clicked"),this.canvas.canvas.onmousedown=e(this,"pickup"),this.canvas.canvas.onmouseup=e(this,"drop"),this.canvas.canvas.onmouseout=e(this,"drop"),this.canvas.canvas.onmousemove=e(this,"drag"),this.canvas.canvas.onmousewheel=e(this,"scroll"),this.canvas.canvas.addEventListener("DOMMouseScroll",e(this,"scroll"));var f=(window.devicePixelRatio||1)/c(this.canvas);f>1&&(this.canvas.canvas.style.height=this.canvas.canvas.height+"px",this.canvas.canvas.style.width=this.canvas.canvas.width+"px",this.canvas.canvas.width*=f,this.canvas.canvas.height*=f)};return i.prototype={close:function(){this.div.style.display="none"},mouseover:function(a){a.style.backgroundColor="#E2E3DF"},mouseout:function(a){a.style.backgroundColor="transparent"},open:function(a,b){for(;this.div.hasChildNodes();)this.div.removeChild(this.div.firstChild);for(var c=0;c<this.elements.length;c++){var f=this.tree.root.clicked(this.tree.translateClickX(a),this.tree.translateClickY(b));f&&(f.leaf&&!this.elements[c].leaf&&this.elements[c].internal||!f.leaf&&!this.elements[c].internal&&this.elements[c].leaf)||!f&&(this.elements[c].leaf||this.elements[c].internal)||(d=document.createElement("div"),d.appendChild(document.createTextNode(this.elements[c].text)),this.elements[c].leaf||this.elements[c].internal?d.addEventListener("click",e(f,this.elements[c].handler)):d.addEventListener("click",e(this.tree,this.elements[c].handler)),d.style.cursor="pointer",d.style.padding="0.3em 0.5em 0.3em 0.5em",d.style.fontFamily=this.tree.font,d.style.fontSize=this.tree.textSize+"pt",d.addEventListener("click",e(this,"close")),d.addEventListener("contextmenu",function(a){a.preventDefault()}),d.addEventListener("mouseover",e(d,this.mouseover)),d.addEventListener("mouseout",e(d,this.mouseout)),this.div.appendChild(d))}a&&b?(this.div.style.top=b+"px",this.div.style.left=a+"px"):(this.div.style.top="100px",this.div.style.left="100px"),this.div.style.zIndex=2e3,this.div.style.display="block",this.div.style.backgroundColor="#FFFFFF"}},j.prototype={run:function(){var a=0;this.cl.style.diangle="block",this.initLoader();var b=this;this.drawer=setInterval(function(){b.drawLoader(a),a++},10)},resize:function(){this.cl.style.top="2px",this.cl.style.left="2px",this.cl.height=.75*this.div.offsetHeight,this.cl.width=.75*this.div.offsetWidth,this.ctx.strokeStyle="rgba(180,180,255,1)",this.ctx.fillStyle="rgba(180,180,255,1)",this.ctx.lineWidth=10,this.ctx.font="24px sans-serif",this.ctx.shadowOffsetX=2,this.ctx.shadowOffsetY=2},initLoader:function(){this.ctx.strokeStyle="rgba(180,180,255,1)",this.ctx.fillStyle="rgba(180,180,255,1)",this.ctx.lineWidth=10,this.ctx.font="24px sans-serif",this.ctx.shadowOffsetX=2,this.ctx.shadowOffsetY=2},drawLoader:function(a){this.ctx.restore(),this.ctx.translate(0,0),this.loader_radius=Math.min(this.ctx.canvas.width/4,this.ctx.canvas.height/4),this.ctx.save(),this.ctx.clearRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height),this.ctx.translate(this.ctx.canvas.width/2,this.ctx.canvas.height/2),this.ctx.beginPath(),this.ctx.arc(0,0,this.loader_radius,this.loader_step*a,this.loader_step*a+2),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.arc(0,0,this.loader_radius,this.loader_step*a+3,this.loader_step*a+5),this.ctx.stroke();var b=this.message;this.ctx.fillText(b,-(this.ctx.measureText(b).width/2),this.loader_radius+50,this.cl.width)},stop:function(){clearInterval(this.drawer),this.cl.style.display="none"},fail:function(a){clearInterval(this.drawer),this.loader_radius=Math.min(this.ctx.canvas.width/4,this.ctx.canvas.height/4),this.ctx.restore(),this.ctx.translate(0,0),this.ctx.clearRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height),this.ctx.beginPath(),this.ctx.strokeStyle="rgba(255,180,180,1)",this.ctx.fillStyle="rgba(255,180,180,1)",this.ctx.translate(this.ctx.canvas.width/2,this.ctx.canvas.height/2),this.ctx.beginPath(),this.ctx.moveTo(0,0),this.ctx.lineTo(this.loader_radius,this.loader_radius),this.ctx.moveTo(0,0),this.ctx.lineTo(-this.loader_radius,this.loader_radius),this.ctx.moveTo(0,0),this.ctx.lineTo(-this.loader_radius,-this.loader_radius),this.ctx.moveTo(0,0),this.ctx.lineTo(this.loader_radius,-this.loader_radius),this.ctx.stroke(),this.ctx.fillText(a,-(this.ctx.measureText(a).width/2),this.loader_radius+50,2*this.loader_radius)}},k.prototype={drawFrame:function(){this.ctx.restore(),this.ctx.save();var a=this.cel.width,b=this.cel.height,c=a/2,d=b/2;if(this.ctx.clearRect(-c,-d,a,b),this.ctx.strokeStyle="rgba(180,180,255,1)",this.tree.drawn)this.ctx.drawImage(this.img,-c,-d,this.cel.width,this.cel.height);else{var e=this.tree.canvas.canvas.toDataURL();this.img=document.createElement("img"),this.img.src=e;var f=this;this.img.onload=function(){f.ctx.drawImage(f.img,-c,-d,f.cel.width,f.cel.height)},this.baseOffsetx=this.tree.offsetx,this.baseOffsety=this.tree.offsety,this.baseZoom=this.tree.zoom}var g=1/(this.tree.zoom/this.baseZoom);this.ctx.lineWidth=this.ctx.lineWidth/g,this.ctx.translate((this.baseOffsetx-this.tree.offsetx*g)*g,(this.baseOffsety-this.tree.offsety*g)*g),this.ctx.scale(g,g),this.ctx.strokeRect(-c,-d,a,b)},resize:function(){this.cel.width=this.tree.canvas.canvas.width/3,this.cel.height=this.tree.canvas.canvas.height/3,this.ctx.translate(this.cel.width/2,this.cel.height/2),this.drawFrame()}},h.prototype={clicked:function(a,b){if(!this.dragging){if(a<this.maxx&&a>this.minx&&b<this.maxy&&b>this.miny)return this;for(var c=this.children.length-1;c>=0;c--)if(cld=this.children[c].clicked(a,b))return cld;return!1}},drawLabel:function(){try{this.canvas.font=Math.max(Math.round(this.tree.textSize/this.tree.zoom),4)+"pt "+this.tree.font;var a=this.label?this.label:this.id,b=this.canvas.measureText(a),c=this.centerx+b.width*(.5*Math.cos(this.angle)-.5)+(5+2*this.radius)*Math.cos(this.angle),d=this.centery+(.5*this.tree.textSize*Math.sin(this.angle)+.5)+(5+2*this.radius)*Math.sin(this.angle);this.canvas.beginPath(),this.canvas.fillStyle=this.selected?this.tree.selectedColor:this.tree.branchColor,this.canvas.fillText(a,c,d),this.canvas.closePath()}catch(e){alert(e)}},drawNode:function(){var a=this.radius*this.tree.baseNodeSize,b=this.radius*this.tree.baseNodeSize,c=this.leaf?b*Math.cos(this.angle)+this.centerx:this.centerx,d=this.leaf?b*Math.sin(this.angle)+this.centery:this.centery;if(this.canvas.beginPath(),this.canvas.fillStyle=this.selected?this.tree.selectedColor:this.color,a*this.tree.zoom<5){var e=5/this.tree.zoom;this.minx=c-e,this.maxx=c+e,this.miny=d-e,this.maxy=d+e}else this.minx=c-a,this.maxx=c+a,this.miny=d-a,this.maxy=d+a;if(this.collapsed){var g=10*this.radius/this.tree.zoom*Math.cos(this.angle-f.QUARTER),h=10*this.radius/this.tree.zoom*Math.sin(this.angle-f.QUARTER),i=10*this.radius/this.tree.zoom*Math.cos(this.angle),j=10*this.radius/this.tree.zoom*Math.sin(this.angle);this.canvas.beginPath(),this.canvas.moveTo(this.centerx-g,this.centery-h),this.canvas.lineTo(this.centerx+g,this.centery+h),this.canvas.lineTo(this.centerx+i,this.centery+j),this.canvas.lineTo(this.centerx-g,this.centery-h),this.canvas.closePath(),this.canvas.fill()}else this.leaf&&(this.canvas.save(),this.canvas.translate(this.centerx,this.centery),this.canvas.rotate(this.angle),this.tree.nodeRenderers[this.nodeShape](this),this.canvas.restore(),this.tree.showLabels&&this.drawLabel());if(this.canvas.closePath(),this.highlighted){this.canvas.beginPath();var k=this.canvas.lineWidth;this.canvas.strokeStyle=this.tree.highlightColor,this.canvas.lineWidth=this.tree.highlightWidth/this.tree.zoom,this.canvas.arc(c,d,(this.leaf?this.radius*this.tree.baseNodeSize:0)+(5+this.tree.highlightWidth/2)/this.tree.zoom,0,f.FULL,!1),this.canvas.stroke(),this.canvas.lineWidth=k,this.canvas.strokeStyle=this.tree.branchColor,this.canvas.beginPath()}},getChildIds:function(){if(this.leaf)return this.id;for(var a=[],b=0;b<this.children.length;b++)a.push(this.children[b].getChildIds());return a.join(",")},getChildCount:function(){if(this.leaf)return 1;for(var a=0,b=0;b<this.children.length;b++)a+=this.children[b].getChildCount();return a},getChildYTotal:function(){if(this.leaf)return this.centery;for(var a=0,b=0;b<this.children.length;b++)a+=this.children[b].getChildYTotal();return a},setSelected:function(a,b){var c=this.id;if(this.selected=a,b)for(var d=0;d<this.children.length;d++)c=c+","+this.children[d].setSelected(a,b);return c},setHighlighted:function(a){if(this.highlighted=a,!a)for(var b=0;b<this.children.length;b++)this.children[b].setHighlighted(a)},reset:function(){this.startx=0,this.starty=0,this.centerx=0,this.centery=0,this.angle=null,this.minChildAngle=f.FULL,this.maxChildAngle=0;for(cld in this.children)try{this.children[cld].pcReset()}catch(a){}},parseNwk:function(a,b){return b=this.parseLabel(a,b),":"==a[b]?b=this.parseNodeLength(a,b+1):this.branchLength=0,this.id&&""!=this.id||(this.id=this.tree.genId()),b},parseLabel:function(a,b){var c="";for(b;":"!=a[b]&&","!=a[b]&&")"!=a[b]&&b<a.length;b++)c+=a[b];if(!c)return b;if(c.match(/\*/)){var d=c.split("**");if(this.id=d[0],1==d.length)return b;d=d[1].split("*");for(var e=0;e<d.length;e+=2)switch(d[e]){case"nsz":this.radius=parseInt(d[e+1]);break;case"nsh":this.nodeShape=g[d[e+1]]?g[d[e+1]]:this.nodeRenderers[d[e+1]]?d[e+1]:"circle";break;case"ncol":this.color=d[e+1];var f="0x"+this.color.substring(0,2),h="0x"+this.color.substring(2,4),i="0x"+this.color.substring(4,6);this.color="rgba("+parseInt(f,16).toString()+","+parseInt(h,16).toString()+","+parseInt(i,16).toString()+",1)"}}else this.id=c;return b},parseNodeLength:function(a,b){var c="";for(b;")"!=a[b]&&","!=a[b];b++)c+=a[b];return this.branchLength=parseFloat(c),this.branchLength<0&&(this.branchLength=0),b},redrawTreeFromBranch:function(){this.tree.redrawFromBranch(this)},saveChildren:function(){for(var a=0;a<this.children.length;a++)this.tree.saveNode(this.children[a]),this.children[a].saveChildren()},collapse:function(){this.collapsed=this.leaf===!1},expand:function(){this.collapsed=!1},toggleCollapsed:function(){this.collapsed?this.expand():this.collapse()},setTotalLength:function(){this.parent?(this.totalBranchLength=this.parent.totalBranchLength+this.branchLength,this.totalBranchLength>this.tree.maxBranchLength&&(this.tree.maxBranchLength=this.totalBranchLength)):(this.totalBranchLength=this.branchLength,this.tree.maxBranchLength=this.totalBranchLength);for(var a=0;a<this.children.length;a++)this.children[a].setTotalLength()}},h.prototype.addChild=function(a){a.parent=this,a.childNo=this.children.length,a.canvas=this.canvas,a.tree=this.tree,this.children.push(a)},l.prototype={AJAX:function(a,b,c,d,e,f,g){var h;h=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP"),h.onreadystatechange=function(){4==h.readyState&&(200==h.status?d(h,e,f):g&&g(h,e,f))},h.open(b,a,!0),"GET"==b?h.send():h.send(c)},branchRenderers:{rectangular:function(a,b,c){var d=b.branchLength*a.branchScalar;b.angle=0,b.parent&&(b.centerx=b.startx+d),b.selected?(b.canvas.strokeStyle=a.selectedColor,b.canvas.fillStyle=a.selectedColor):(b.canvas.strokeStyle=a.branchColor,b.canvas.fillStyle=b.color),b.canvas.beginPath(),c||(b.canvas.moveTo(b.startx,b.starty),b.canvas.lineTo(b.startx,b.centery),b.canvas.lineTo(b.centerx,b.centery),b.canvas.stroke(),b.canvas.closePath(),b.drawNode()),b.canvas.closePath();for(var e=0;e<b.children.length&&!c;e++)b.children[e].startx=b.centerx,b.children[e].starty=b.centery,b.children[e].selected&&!b.collapsed?a.selectedNodes.push(b.children[e]):a.branchRenderers.rectangular(a,b.children[e],b.collapsed||c)},circular:function(a,b,c){var d=b.totalBranchLength*a.branchScalar;if(b.selected?(b.canvas.strokeStyle=b.tree.selectedColor,b.canvas.fillStyle=b.tree.selectedColor):(b.canvas.strokeStyle=b.tree.branchColor,b.canvas.fillStyle=b.color),!c){if(b.canvas.beginPath(),b.canvas.moveTo(b.startx,b.starty),b.leaf){b.canvas.lineTo(b.interx,b.intery),b.canvas.stroke();var e=b.canvas.strokeStyle;b.canvas.strokeStyle=b.selected?b.tree.selectedColor:"rgba(0,0,0,0.5)",b.canvas.lineTo(b.centerx,b.centery),b.canvas.stroke(),b.canvas.strokeStyle=e}else b.canvas.lineTo(b.centerx,b.centery),b.canvas.stroke();b.canvas.strokeStyle=b.selected?b.tree.selectedColor:b.tree.branchColor,b.children.length>1&&!b.collapsed&&(b.canvas.beginPath(),b.canvas.arc(0,0,d,b.minChildAngle,b.maxChildAngle,b.maxChildAngle<b.minChildAngle),b.canvas.stroke(),b.canvas.closePath()),b.drawNode()}for(var f=0;f<b.children.length&&!c;f++)a.branchRenderers.circular(a,b.children[f],b.collapsed||c)},radial:function(a,b,c){b.selected?(b.canvas.strokeStyle=b.tree.selectedColor,b.canvas.fillStyle=b.tree.selectedColor):(b.canvas.strokeStyle=b.tree.branchColor,b.canvas.fillStyle=b.color),b.parent&&!c&&(b.canvas.beginPath(),b.canvas.moveTo(b.startx,b.starty),b.canvas.lineTo(b.centerx,b.centery),b.canvas.stroke(),b.canvas.closePath(),b.drawNode());for(var d=0;d<b.children.length&&!c;d++)b.children[d].selected&&!b.collapsed?b.tree.selectedNodes.push(b.children[d]):a.branchRenderers.radial(a,b.children[d],b.collapsed||c)},diagonal:function(a,b,c){b.angle=0,b.selected?(b.canvas.strokeStyle=b.tree.selectedColor,b.canvas.fillStyle=b.tree.selectedColor):(b.canvas.strokeStyle=b.tree.branchColor,b.canvas.fillStyle=b.color),b.canvas.beginPath(),c||(b.canvas.moveTo(b.startx,b.starty),b.canvas.lineTo(b.centerx,b.centery),b.canvas.stroke(),b.canvas.closePath(),b.drawNode()),b.canvas.closePath();for(var d=0;d<b.children.length&&!c;d++)b.children[d].startx=b.centerx,b.children[d].starty=b.centery,b.children[d].selected&&!b.collapsed?b.tree.selectedNodes.push(b.children[d]):a.branchRenderers.diagonal(a,b.children[d],b.collapsed||c)},hierarchy:function(a,b,c){b.selected?(b.canvas.strokeStyle=b.tree.selectedColor,b.canvas.fillStyle=b.tree.selectedColor):(b.canvas.strokeStyle=b.tree.branchColor,b.canvas.fillStyle=b.color),c||(b.canvas.beginPath(),b!=b.tree.root&&(b.canvas.moveTo(b.startx,b.starty),b.canvas.lineTo(b.centerx,b.starty)),b.canvas.lineTo(b.centerx,b.centery),b.canvas.stroke(),b.drawNode()),b.canvas.closePath();for(var d=0;d<b.children.length&&!c;d++)!b.children[d].selected||c||b.collapsed?a.branchRenderers.hierarchy(a,b.children[d],b.collapsed||c):b.tree.selectedNodes.push(b.children[d])}},clicked:function(a){if(this.contextMenu.close(),0==a.button)try{if(this.dragging)return void(this.dragging=!1);if(!this.root)return!1;var b=this.root.clicked(this.translateClickX(a.clientX),this.translateClickY(a.clientY));return b?(this.root.setSelected(!1,!0),(this.internalNodesSelectable||b.leaf)&&(b.setSelected(!0,!0),this.onselected&&b.getChildIds&&this.onselected(b.getChildIds()))):this.unselectOnClickAway&&!this.dragging&&(this.root.setSelected(!1,!0),this.onselected&&this.onselected("")),this.draw(),this.pickedup||(this.dragging=!1),!1}catch(a){alert(a)}else 2==a.button&&(a.preventDefault(),this.contextMenu.open(a.clientX,a.clientY))},dblclicked:function(a){if(!this.root)return!1;var b=this.root.clicked(this.translateClickX(1*a.clientX),this.translateClickY(1*a.clientY));b&&(b.setSelected(!1,!0),b.toggleCollapsed()),this.pickedup||(this.dragging=!1),this.draw()},displayLabels:function(){this.showLabels=!0,this.draw()},drag:function(a){var b=(window.devicePixelRatio||1)/c(this.canvas);if(!this.drawn)return!1;if(this.pickedup){var d=(a.clientX-this.startx)*b,e=(a.clientY-this.starty)*b;Math.abs(d)+Math.abs(e)>5&&(this.dragging=!0,this.offsetx=this.origx+d,this.offsety=this.origy+e,this.draw())}else if(this.zoomPickedUp)this.d=(this.starty-a.clientY)/100,x=this.translateClickX(this.startx),this.setZoom(this.origZoom+this.d),this.draw();else{var f=a,g=this.root.clicked(this.translateClickX(1*f.clientX),this.translateClickY(1*f.clientY));g&&(this.internalNodesSelectable||g.leaf)?(this.root.setHighlighted(!1),g.setHighlighted(!0)):this.root.setHighlighted(!1),this.draw()}},draw:function(){if(this.selectedNodes=[],0!=this.maxBranchLength){this.canvas.restore(),this.canvas.clearRect(0,0,this.canvas.canvas.width,this.canvas.canvas.height),this.canvas.lineCap="round",this.canvas.lineJoin="round",this.canvas.strokeStyle=this.branchColor,this.canvas.save(),this.canvas.translate(this.canvas.canvas.width/2/c(this.canvas),this.canvas.canvas.height/2/c(this.canvas)),this.drawn||this.prerenderers[this.treeType](this),this.canvas.translate(this.offsetx,this.offsety),this.canvas.scale(this.zoom,this.zoom),this.canvas.lineWidth=this.lineWidth/this.zoom,this.branchRenderers[this.treeType](this,this.root);for(var a=0;a<this.selectedNodes.length;a++)this.branchRenderers[this.treeType](this,this.selectedNodes[a]);this.navigator&&this.navigator.drawFrame(),this.drawn=!0,this.loader.stop()}},drop:function(){return this.drawn?(this.pickedup=!1,void(this.zoomPickedUp=!1)):!1},findBranch:function(a){this.root.setSelected(!1,!0);for(var b=0;b<this.leaves.length;b++)this.leaves[b].id.match(new RegExp(a,"i"))&&this.leaves[b].setSelected(!0,!0);this.draw()},genId:function(){return"pcn"+this.lastId++},getPngUrl:function(){return this.canvas.canvas.toDataURL()},hideLabels:function(){this.showLabels=!1,this.draw()},load:function(a,b,c){c?c.match(/nexus/i)?a.match(/\.\w+$/)?this.AJAX(a,"GET","",this.loadFileCallback,{format:"nexus",name:b},this):this.parseNexus(a,b):c.match(/newick/i)&&(a.match(/\.\w+$/)?this.AJAX(a,"GET","",this.loadFileCallback,{format:"newick"},this):this.parseNwk(a,b)):a.match(/\.n(ex|xs)$/)?this.AJAX(a,"GET","",this.loadFileCallback,{format:"nexus",name:b},this):a.match(/\.nwk$/)?this.AJAX(a,"GET","",this.loadFileCallback,{format:"newick"},this):a.match(/^#NEXUS[\s\n;\w\.\*\:(\),-=\[\]\/&]+$/i)?this.parseNexus(a,b):a.match(/^[\w\.\*\:(\),-\/]+;\s?$/gi)&&this.parseNwk(a,b)},loadFileCallback:function(a,b,c){if(b.format.match(/nexus/i))c.parseNexus(reponse.responseText,b.name);else{if(!b.format.match(/newick/i))throw"file type not recognised by PhyloCanvas";c.parseNwk(a.responseText)}c.draw()},nodePrerenderers:{radial:function(a,b){b.parent?(b.startx=b.parent.centerx,b.starty=b.parent.centery):(b.startx=0,b.starty=0),b.centerx=b.startx+b.branchLength*a.branchScalar*Math.cos(b.angle),b.centery=b.starty+b.branchLength*a.branchScalar*Math.sin(b.angle),a.minx=Math.min(b.centerx,a.minx),a.maxx=Math.max(b.centerx,a.maxx),a.miny=Math.min(b.centery,a.miny),a.maxy=Math.max(b.centery,a.maxy);for(var c=0;c<b.children.length;c++)this.radial(a,b.children[c])}},nodeRenderers:{circle:function(a){var b=a.radius*a.tree.baseNodeSize;a.canvas.arc(b,0,b,0,f.FULL,!1),a.canvas.stroke(),a.canvas.fill()},square:function(a){var b=a.radius*a.tree.baseNodeSize,c=0,d=2*b,e=-b,f=b;a.canvas.moveTo(c,e),a.canvas.lineTo(c,f),a.canvas.lineTo(d,f),a.canvas.lineTo(d,e),a.canvas.lineTo(c,e),a.canvas.stroke(),a.canvas.fill()},star:function(a){var b=a.radius*a.tree.baseNodeSize,c=b,d=0;a.canvas.moveTo(c,d);for(var e=2*Math.PI/10,f=1.75*b,g=11;0!=g;g--){var h=g%2==1?f:b,i=e*g;a.canvas.lineTo(c+h*Math.sin(i),d+h*Math.cos(i))}a.canvas.stroke(),a.canvas.fill()},triangle:function(a){var b=a.radius*a.tree.baseNodeSize,c=b,d=0,e=c-b,f=c+b,g=d-b,h=d+b;a.canvas.moveTo(c,g),a.canvas.lineTo(f,h),a.canvas.lineTo(e,h),a.canvas.lineTo(c,g),a.canvas.stroke(),a.canvas.fill()}},parseNexus:function(a,b){if(!a.match(/^#NEXUS[\s\n;\w\.\*\/\:(\),-=\[\]&]+$/i))throw"the string provided was not a nexus string";if(!a.match(/BEGIN TREES/gi))throw"The nexus file does not contain a tree block";var c=a.match(/BEGIN TREES;[\S\s]+END;/i)[0].replace(/BEGIN TREES;\n/i,"").replace(/END;/i,""),d=c.match(/TRANSLATE[^;]+;/i)[0];c=c.replace(d,""),d=d.replace(/translate|;/gi,"");for(var e,f=d.split(","),g={},h=0;h<f.length;h++)e=f[h].replace("\n","").split(" "),g[e[0].trim()]=e[1].trim();for(var i=c.split("\n"),j={},h=0;h<i.length;h++)if(""!=i[h].trim()){var a=i[h].replace(/tree\s/i,"");j[a.match(/^\w+/)[0]]=a.match(/ [\S]*$/)[0]}if(!j[b])throw"tree "+b+" does not exist in this NEXUS file";this.parseNwk(j[b].trim());for(var k in g){var l=this.branches[k];delete this.branches[k],l.id=g[k],this.branches[l.id]=l}},parseNwk:function(a){this.origBranches=!1,this.origLeaves=!1,this.origRoot=!1,this.origBL={},this.origP={},this.loader.drawer||this.loader.run(),this.loader.resize(),this.root=!1,this.leaves=[],this.branches={},this.drawn=!1;var b=new h;b.id="root",this.branches.root=b,this.setRoot(b);for(var c=0;c<a.length;c++)switch(a[c]){case"(":var d=new h;b.leaf=!1,b.addChild(d),b=d;break;case")":b.leaf&&this.leaves.push(b),b=b.parent;break;case",":var d=new h;b.leaf&&this.leaves.push(b),b.parent.addChild(d),b=d;break;case";":for(var e=0;e<this.leaves.length;e++)this.leaves[e].totalBranchLength>this.maxBranchLength&&(this.maxBranchLength=this.leaves[e].totalBranchLength);break;default:try{c=b.parseNwk(a,c),c--}catch(f){return void alert("Error parsing nwk file"+f)}}this.saveNode(this.root),this.root.saveChildren(),this.root.branchLength=0,this.maxBranchLength=0,this.root.setTotalLength(),0==this.maxBranchLength&&this.loader.fail("All branches in the tree are identical.")},pickup:function(a){return this.contextMenu.close(),this.drawn?(this.origx=this.offsetx,this.origy=this.offsety,0==a.button&&(this.pickedup=!0),2==a.button&&this.rightClickZoom&&(this.zoomPickedUp=!0,this.origZoom=Math.log(this.zoom)/Math.log(10),this.oz=this.zoom),this.startx=a.clientX,void(this.starty=a.clientY)):!1},prerenderers:{rectangular:function(a){a.root.startx=0,a.root.starty=0,a.root.centerx=0,a.root.centery=0,a.branchScalar=a.canvas.canvas.width/a.maxBranchLength;for(var b=Math.max(a.canvas.canvas.height/(a.leaves.length+2),2*(a.leaves[0].radius+2)),c=0;c<a.leaves.length;c++){a.leaves[c].angle=0,a.leaves[c].centery=c>0?a.leaves[c-1].centery+b:0,a.leaves[c].centerx=a.leaves[c].totalBranchLength*a.branchScalar;for(var d=a.leaves[c];d.parent&&(0==d.childNo&&(d.parent.centery=d.centery),d.childNo==d.parent.children.length-1);d=d.parent)d.parent.centery=(d.parent.centery+d.centery)/2}var e=a.leaves[0].centery-a.leaves[0].radius,f=a.leaves[a.leaves.length-1].centery+a.leaves[a.leaves.length-1].radius,g=0,h=a.maxBranchLength*a.branchScalar+2*a.leaves[0].radius;a.root.startx=a.root.centerx,a.root.starty=a.root.centery,a.zoom=Math.min((a.canvas.canvas.width-100)/h,(a.canvas.canvas.height-100)/(f-e)),a.offsetx=-((h-g)*a.zoom/2),a.offsety=-((f-e)*a.zoom/2)},circular:function(a){a.root.startx=0,a.root.starty=0,a.root.centerx=0,a.root.centery=0,a.branchScalar=Math.min(a.canvas.canvas.width,a.canvas.canvas.height)/a.maxBranchLength;var b=a.leaves.length*a.leaves[0].radius*2/f.FULL;a.branchScalar*a.maxBranchLength>b?b=a.branchScalar*a.maxBranchLength:a.branchScalar=b/a.maxBranchLength;for(var c=f.FULL/a.leaves.length,d=0;d<a.leaves.length;d++){a.leaves[d].angle=c*d,a.leaves[d].centery=b*Math.sin(a.leaves[d].angle),a.leaves[d].centerx=b*Math.cos(a.leaves[d].angle),a.leaves[d].starty=a.leaves[d].parent.totalBranchLength*a.branchScalar*Math.sin(a.leaves[d].angle),a.leaves[d].startx=a.leaves[d].parent.totalBranchLength*a.branchScalar*Math.cos(a.leaves[d].angle),a.leaves[d].intery=a.leaves[d].totalBranchLength*a.branchScalar*Math.sin(a.leaves[d].angle),a.leaves[d].interx=a.leaves[d].totalBranchLength*a.branchScalar*Math.cos(a.leaves[d].angle);for(var e=a.leaves[d];e.parent&&(0==e.childNo&&(e.parent.angle=e.angle,e.parent.minChildAngle=e.angle),e.childNo==e.parent.children.length-1);e=e.parent)e.parent.maxChildAngle=e.angle,e.parent.angle=(e.parent.minChildAngle+e.parent.maxChildAngle)/2,e.parent.centery=e.parent.totalBranchLength*a.branchScalar*Math.sin(e.parent.angle),e.parent.centerx=e.parent.totalBranchLength*a.branchScalar*Math.cos(e.parent.angle),e.parent.starty=(e.parent.totalBranchLength-e.parent.branchLength)*a.branchScalar*Math.sin(e.parent.angle),e.parent.startx=(e.parent.totalBranchLength-e.parent.branchLength)*a.branchScalar*Math.cos(e.parent.angle)}a.offsetx=0,a.offsety=0,a.zoom=(Math.min(a.canvas.canvas.width,a.canvas.canvas.height)-50-a.leaves[0].radius)/(2*b)},radial:function(a){a.branchScalar=Math.min(a.canvas.canvas.width,a.canvas.canvas.height)/a.maxBranchLength;var b=f.FULL/a.leaves.length;a.root.startx=0,a.root.starty=0,a.root.centerx=0,a.root.centery=0;for(var c=0;c<a.leaves.length;c+=1){a.leaves[c].angle=b*c,a.leaves[c].centerx=a.leaves[c].totalBranchLength*a.branchScalar*Math.cos(a.leaves[c].angle),a.leaves[c].centery=a.leaves[c].totalBranchLength*a.branchScalar*Math.sin(a.leaves[c].angle);for(var d=a.leaves[c];d.parent&&(0==d.childNo&&(d.parent.angle=0),d.parent.angle+=d.angle*d.getChildCount(),d.childNo==d.parent.children.length-1);d=d.parent)d.parent.angle=d.parent.angle/d.parent.getChildCount()}a.minx=Number.MAX_VALUE,a.maxx=-Number.MAX_VALUE,a.miny=Number.MAX_VALUE,a.maxy=-Number.MAX_VALUE,a.nodePrerenderers.radial(a,a.root);var e=a.maxx-a.minx,g=a.maxy-a.miny;a.zoom=Math.min((a.canvas.canvas.width-50)/e,(a.canvas.canvas.height-50)/g),a.offsetx=-((a.minx+a.maxx)/2)*a.zoom,a.offsety=-((a.miny+a.maxy)/2)*a.zoom},diagonal:function(a){for(var b=Math.max(a.canvas.canvas.height/(a.leaves.length+2),2*(a.leaves[0].radius+2)),c=0;c<a.leaves.length;c++){a.leaves[c].centerx=0,a.leaves[c].centery=c>0?a.leaves[c-1].centery+b:0,a.leaves[c].angle=0;for(var d=a.leaves[c];d.parent&&d.childNo==d.parent.children.length-1;d=d.parent){d.parent.centery=d.parent.getChildYTotal()/d.parent.getChildCount(),d.parent.centerx=d.parent.children[0].centerx+(d.parent.children[0].centery-d.parent.centery)*Math.tan(f.FORTYFIVE);for(var e=0;e<d.parent.children.length;e++)d.parent.children[e].startx=d.parent.centerx,d.parent.children[e].starty=d.parent.centery}}var g=a.leaves[0].centery-a.leaves[0].radius,h=a.leaves[a.leaves.length-1].centery+a.leaves[a.leaves.length-1].radius,i=0,j=a.maxBranchLength+2*a.leaves[0].radius;a.root.startx=a.root.centerx,a.root.starty=a.root.centery,a.offsetx=-(j-i)/2,a.offsety=-h/2,a.zoom=Math.min((a.canvas.canvas.width-20)/(j-i),(a.canvas.canvas.height-20)/(h-g))},hierarchy:function(a){a.root.startx=0,a.root.starty=0,a.root.centerx=0,a.root.centery=0,a.branchScalar=a.canvas.canvas.height/a.maxBranchLength;for(var b=Math.max(a.canvas.canvas.width/(a.leaves.length+2),2*(a.leaves[0].radius+2)),c=0;c<a.leaves.length;c++){a.leaves[c].angle=f.QUARTER,a.leaves[c].centerx=c>0?a.leaves[c-1].centerx+b:0,a.leaves[c].centery=a.leaves[c].totalBranchLength*a.branchScalar;for(var d=a.leaves[c];d.parent&&(0==d.childNo&&(d.parent.centerx=d.centerx),d.childNo==d.parent.children.length-1);d=d.parent){d.parent.angle=f.QUARTER,d.parent.centerx=(d.parent.centerx+d.centerx)/2,d.parent.centery=d.parent.totalBranchLength*a.branchScalar;for(var e=0;e<d.parent.children.length;e++)d.parent.children[e].startx=d.parent.centerx,d.parent.children[e].starty=d.parent.centery}}var g=a.leaves[0].centerx-a.leaves[0].radius,h=a.leaves[a.leaves.length-1].centerx+a.leaves[a.leaves.length-1].radius,i=0,j=a.maxBranchLength*a.branchScalar+2*a.leaves[0].radius;a.zoom=Math.min((a.canvas.canvas.width-50)/(h-g),(a.canvas.canvas.height-50)/(j-i)),a.root.startx=a.root.centerx,a.root.starty=a.root.centery,a.offsety=-((j-i)*a.zoom/2),a.offsetx=-((h-g)*a.zoom/2)}},redrawGetNodes:function(a,b){for(var c=0;c<a.children.length;c++)this.branches[a.children[c].id]=a.children[c],a.children[c].leaf?(b.push(a.children[c].id),this.leaves.push(a.children[c])):this.redrawGetNodes(a.children[c],b)},redrawFromBranch:function(a){this.totalBranchLength=0,this.origBranches||(this.origBranches=this.branches),this.origLeaves||(this.origLeaves=this.leaves),this.origRoot||(this.origRoot=this.root),this.origBL[a.id]=a.branchLength,this.origP[a.id]=a.parent,this.root=a,this.root.branchLength=0,this.root.parent=!1,this.branches={},this.leaves=[];for(var b=[],c=0;c<this.root.children.length;c++)this.branches[this.root.children[c].id]=this.root.children[c],this.root.children[c].leaf?(this.leaves.push(this.root.children[c]),b.push(this.root.children[c].id)):this.redrawGetNodes(this.root.children[c],b);this.root.setTotalLength(),this.prerenderers[this.treeType](this),this.draw(),this.onredrawtree&&this.onredrawtree(b)
},redrawOriginalTree:function(){if(this.origBranches){this.branches=this.origBranches;for(var a in this.origBL)this.branches[a].branchLength=this.origBL[a],this.branches[a].parent=this.origP[a];this.leaves=this.origLeaves,this.root=this.origRoot,this.root.setTotalLength(),this.prerenderers[this.treeType](this),this.draw(),this.originalTreeRedrawn&&this.originalTreeRedrawn()}},saveNode:function(a){if(a.id&&""!=a.id||(a.id=a.tree.genId()),this.branches[a.id]){if(a!=this.branches[a.id]){if(this.leaf)throw"Two nodes on this tree share the id "+a.id;a.id=this.genId(),this.branches[a.id]=a}}else this.branches[a.id]=a},scroll:function(a){try{this.contextMenu.close(),a.preventDefault();var b=Math.log(this.zoom)/Math.log(10);this.setZoom(b+(a.wheelDelta?a.wheelDelta/1e3:a.detail/-100))}catch(a){alert(a)}},selectNodes:function(a){this.root.setSelected(!1,!0);for(var b=a.split(","),c=0;c<this.leaves.length;c++)for(var d=0;d<b.length;d++)this.leaves[c].setSelected(b[d]==this.leaves[c].id,!1);this.draw()},setFont:function(a){this.font=a,this.draw()},setNodeColourAndShape:function(a,b,c,d,e){if(a)if(this.drawn){var f=[];if(f="string"==typeof a?a.split(","):a,""!=a){for(var h=0;h<f.length;h++)this.branches[f[h]]&&(b&&(this.branches[f[h]].color=b),c&&(this.branches[f[h]].nodeShape=g[c]?g[c]:c),d&&(this.branches[f[h]].radius=d));this.draw()}}else if(!e)var i=this,j=setInterval(function(){this.drawn&&(i.setNodeColourAndShape(a,b,c,d,!0),console.debug("clear"),clearInterval(j))})},setNodeSize:function(a){this.baseNodeSize=Number(a),this.draw()},setRoot:function(a){a.canvas=this.canvas,a.tree=this,this.root=a},setTextSize:function(a){this.textSize=Number(a),this.draw()},setTreeType:function(a){this.drawn=!1,this.treeType=a,this.draw()},setSize:function(a,b){this.canvas.canvas.width=a,this.canvas.canvas.height=b,this.drawn&&this.draw(),this.loader.resize(),this.navigator&&this.navigator.resize()},setZoom:function(a){if(a>-2&&2>a){var b=this.zoom;this.zoom=Math.pow(10,a),this.offsetx=this.offsetx/b*this.zoom,this.offsety=this.offsety/b*this.zoom,this.draw()}},toggleLabels:function(){this.showLabels=!this.showLabels,this.draw()},translateClickX:function(a){var d=(window.devicePixelRatio||1)/c(this.canvas);return a=a-b(this.canvas.canvas)+window.pageXOffset,a*=d,a-=this.canvas.canvas.width/2,a-=this.offsetx,a/=this.zoom},translateClickY:function(b){var d=(window.devicePixelRatio||1)/c(this.canvas);return b=b-a(this.canvas.canvas)+window.pageYOffset,b*=d,b-=this.canvas.canvas.height/2,b-=this.offsety,b/=this.zoom}},{Tree:l,Branch:h,Loader:j,ContextMenu:i}}();!function(){"use strict";function a(){var a=new b.Tree("phylo");a.load("data/EARSS.nwk");for(var d=c("button.tree-control"),e=d.length;e--;)console.debug(d.length),d[e].addEventListener("click",a[d[e].id].bind(a))}var b=PhyloCanvas,c=document.querySelectorAll.bind(document);document.body.onload=a()}();